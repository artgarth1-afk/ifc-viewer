<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>IFC Viewer</title>
  <style>
    body { margin:0; font-family: sans-serif; }
    #viewer { width:100%; height:80vh; }
    #toolbar {
      height: 10vh;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
      background: #eee;
    }
    #info {
      height: 10vh;
      overflow:auto;
      padding: 5px;
      background: #f9f9f9;
      border-top: 1px solid #ccc;
    }
    button { padding: 6px 12px; }
  </style>
</head>
<body>
  <div id="viewer"></div>
  <div id="toolbar">
    <button id="resetCamera">Сброс камеры</button>
    <button id="toggleModel">Скрыть/Показать модель</button>
    <button id="isolate">Изоляция объекта</button>
    <button id="showAll">Показать всё</button>
    <button id="screenshot">Скриншот PNG</button>
    <button id="showInfo">Информация об объекте</button>
  </div>
  <div id="info">Выберите объект, затем нажмите «Информация об объекте»</div>

  <script type="module">
    import { Viewer, IFCLoader, HighlightMaterial } from './xeokit-sdk.es.js';

    const viewer = new Viewer({ canvasId: "viewer" });

    viewer.camera.eye = [20, 20, 20];
    viewer.camera.look = [0, 0, 0];
    viewer.camera.up = [0, 1, 0];

    // Встроенное управление камерой — без импорта
    viewer.cameraControl.setNavigationMode("orbit");

    const ifcLoader = new IFCLoader(viewer);

    let modelEntity = null;
    let selectedEntity = null;

    ifcLoader.load({
      src: "model.ifc",
      webIfc: {
        wasmPath: "./web-ifc.wasm"
      },
      id: "myModel"
    }).then(model => {
      modelEntity = model;
      console.log("IFC модель загружена!");

      const highlight = new HighlightMaterial(viewer, {
        color: [0, 1, 0],
        alpha: 0.5
      });

      viewer.cameraControl.on("picked", e => {
        if (e.entity) {
          viewer.scene.setObjectsHighlighted(viewer.scene.objects, false);
          e.entity.highlighted = true;
          e.entity.highlightMaterial = highlight;
          selectedEntity = e.entity;
          console.log("Выбран объект:", e.entity.id);
        }
      });
    }).catch(err => {
      console.error("Ошибка загрузки IFC:", err);
    });

    document.getElementById("resetCamera").onclick = () => {
      viewer.camera.eye = [20, 20, 20];
      viewer.camera.look = [0, 0, 0];
      viewer.camera.up = [0, 1, 0];
    };

    document.getElementById("toggleModel").onclick = () => {
      if (modelEntity) {
        modelEntity.visible = !modelEntity.visible;
      }
    };

    document.getElementById("isolate").onclick = () => {
      if (selectedEntity) {
        viewer.scene.setObjectsVisible(viewer.scene.objects, false);
        selectedEntity.visible = true;
      } else {
        alert("Сначала выбери объект кликом по модели!");
      }
    };

    document.getElementById("showAll").onclick = () => {
      viewer.scene.setObjectsVisible(viewer.scene.objects, true);
    };

    document.getElementById("screenshot").onclick = () => {
      const dataURL = viewer.getSnapshot({ format: "png" });
      const link = document.createElement("a");
      link.href = dataURL;
      link.download = "screenshot.png";
      link.click();
    };

    document.getElementById("showInfo").onclick = () => {
      const infoDiv = document.getElementById("info");
      if (selectedEntity) {
        const props = selectedEntity.meta || {};
        let html = `<b>ID:</b> ${selectedEntity.id}<br>`;
        if (props.GlobalId) html += `<b>GUID:</b> ${props.GlobalId}<br>`;
        if (props.Name) html += `<b>Имя:</b> ${props.Name}<br>`;
        if (props.Type) html += `<b>Тип:</b> ${props.Type}<br>`;
        infoDiv.innerHTML = html;
      } else {
        infoDiv.innerHTML = "Сначала выбери объект кликом по модели!";
      }
    };
  </script>
</body>
</html>
